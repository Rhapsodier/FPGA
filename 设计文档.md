# 数字码表FPGA设计文档

## 一、项目概述

### 1.1 项目简介

本项目是一个基于Xilinx Artix-7 FPGA的数字码表系统，具有显示分、秒以及百分秒的秒表功能，支持暂停、复位、时间存储和翻阅功能。

### 1.2 开发环境

- **工具版本**：Vivado 2018.3
- **开发板**：ETL3-7A35T XILINX ARTIX-7 FPGA
- **器件型号**：xc7a35t

### 1.3 功能特性

#### 基础功能
1. **计时功能**：百分秒（0-99）、秒（0-59）、分（0-59）计数
2. **控制功能**：
   - 复位（BTNC/CLR）：按下时所有值清零
   - 暂停（BTNL/PAUSE）：按下时暂停计数
3. **存储功能**：支持存储6组时间，按键记录和翻阅
4. **显示功能**：7段数码管动态扫描显示，格式为MMSS:MS
5. **LED指示**：按键状态LED指示和边沿脉冲测试LED

## 二、系统架构设计

### 2.1 整体架构

采用自顶向下的模块化设计方法，系统分为以下模块：

```
顶层模块 (top_stopwatch)
├── 时钟分频模块
│   ├── clk_div_100Hz (50MHz -> 100Hz，用于百分秒计数)
│   └── clk_div_10KHz (50MHz -> 10KHz，用于动态扫描)
├── 计数控制模块 (counter_control)
│   ├── counter_100 (100进制计数器，百分秒计数)
│   ├── counter_60 (60进制计数器，秒计数)
│   └── counter_60 (60进制计数器，分计数)
├── 存储管理模块 (time_storage)
│   ├── 6组时间存储单元（每组19位）
│   ├── 记录控制逻辑
│   └── 翻阅控制逻辑
├── 数码管驱动模块 (seg7_driver)
│   ├── bin_to_bcd (二进制转BCD码)
│   ├── bcd_to_seg7 (BCD码转7段显示码)
│   └── 动态扫描控制
└── 按键处理模块（顶层模块内）
    ├── 边沿检测
    └── 模式控制
```

### 2.2 信号定义

#### 输入信号
- `clk`: 系统时钟，50MHz（引脚Y19）
- `CLR`: 复位信号，低电平有效（BTNC按键，引脚Y18）
- `PAUSE`: 暂停信号，低电平有效（BTNL按键，引脚W22）
- `record_btn_raw`: 记录按键原始输入，低电平有效（BUTR按键，引脚Y22）
- `browse_btn_raw`: 翻阅按键原始输入，低电平有效（BUTU按键，引脚V22）

#### 输出信号
- `DATA[15:0]`: 数码管数据和控制信号
  - `DATA[7:0]`: 7段显示数据（8位，最高位为小数点，本设计未使用）
  - `DATA[15:8]`: 数码管位选信号（8位，实际使用6位）
- `LED_TEST[1:0]`: LED测试输出
  - `LED_TEST[0]`: record_btn脉冲（LED2，引脚AA20）
  - `LED_TEST[1]`: browse_btn脉冲（LED3，引脚AB18）
- `LED15`: BTNC按键指示（引脚AA1）
- `LED14`: BTNL按键指示（引脚AA3）
- `LED13`: BTNR按键指示（引脚AA4）
- `LED12`: BTNU按键指示（引脚AA5）

### 2.3 显示格式

**显示格式**：MMSS:MS（分分秒秒:毫秒）

**数码管布局**（从左到右）：
- 数码管1 (LED_S1, DATA[9]): 分钟十位
- 数码管0 (LED_S0, DATA[8]): 分钟个位
- 数码管7 (LED_S7, DATA[15]): 秒十位
- 数码管6 (LED_S6, DATA[14]): 秒个位
- 冒号：由硬件固定显示在秒和毫秒之间，不需要单独的位选
- 数码管5 (LED_S5, DATA[13]): 毫秒十位（百分秒十位）
- 数码管4 (LED_S4, DATA[12]): 毫秒个位（百分秒个位）

**注意**：总共使用6个数码管，冒号由硬件固定显示。

## 三、模块详细设计

### 3.1 时钟分频模块

#### clk_div_100Hz
- **功能**：将50MHz时钟分频为100Hz
- **输入**：clk_50MHz (50MHz)
- **输出**：clk_100Hz (100Hz)
- **分频比**：500000 (50MHz / 100Hz = 500000)
- **实现**：计数器计数到249999时翻转输出时钟（二分频）
- **用途**：用于百分秒计数，每100Hz时钟周期计数一次，实现0.01秒精度

#### clk_div_10KHz
- **功能**：将50MHz时钟分频为10KHz
- **输入**：clk_50MHz (50MHz)
- **输出**：clk_10KHz (10KHz)
- **分频比**：5000 (50MHz / 10KHz = 5000)
- **实现**：计数器计数到2499时翻转输出时钟（二分频）
- **用途**：用于数码管动态扫描，每个时钟周期切换一个数码管

### 3.2 计数控制模块

#### counter_100（100进制计数器）
- **功能**：百分秒计数
- **时钟**：clk_100Hz
- **计数范围**：0-99
- **输出**：centisecond[6:0] (7位，最大99)
- **进位**：当计数到99时，下一个时钟周期输出进位信号
- **暂停**：支持pause信号控制

#### counter_60（60进制计数器）
- **功能**：秒和分计数
- **时钟**：clk_100Hz
- **计数范围**：0-59
- **输出**：second[5:0] 或 minute[5:0] (6位，最大59)
- **进位**：当计数到59时，下一个时钟周期输出进位信号
- **使能**：通过enable信号控制，只有收到进位信号时才计数
- **暂停**：支持pause信号控制

#### counter_control（计数控制整合）
- **功能**：整合百分秒、秒、分计数器，形成完整的计时链
- **计数链**：百分秒 -> 秒 -> 分
- **暂停控制**：支持PAUSE按键和翻阅模式暂停

### 3.3 存储管理模块

#### 存储结构
- **容量**：6组时间存储
- **数据格式**：每组19位 = 分钟(6位) + 秒(6位) + 百分秒(7位)
- **实现**：使用寄存器数组 `reg [18:0] time_memory [5:0]`

#### 工作模式

系统有两种工作模式：**实时模式**和**翻阅模式**

**实时模式（browse_mode = 0）**：
- **BUTR按键（record_btn_raw）**：记录当前时间到存储单元
- **BUTU按键（browse_btn_raw）**：进入翻阅模式
- **显示**：实时计时值
- **计时器**：正常运行

**翻阅模式（browse_mode = 1）**：
- **BUTR按键（record_btn_raw）**：翻阅下一个存储的时间（循环显示0-5组）
- **BUTU按键（browse_btn_raw）**：退出翻阅模式，返回实时模式
- **显示**：存储的时间值
- **计时器**：自动暂停（通过browse_mode信号控制）

#### 记录逻辑
- 仅在实时模式下有效
- 检测record_btn上升沿（边沿检测后的脉冲）
- 将当前计数器的值存储到下一个空闲位置
- 如果6组已满，循环覆盖（0-5循环）

#### 翻阅逻辑
- **进入翻阅模式**：在实时模式下，检测browse_btn上升沿，进入翻阅模式，从第0组开始显示
- **翻阅存储时间**：在翻阅模式下，检测record_btn上升沿，切换显示索引（0-5循环）
- **退出翻阅模式**：在翻阅模式下，检测browse_btn上升沿，退出翻阅模式，返回实时模式

### 3.4 数码管驱动模块

#### 功能
1. 二进制转BCD码转换
2. BCD码转7段显示码
3. 动态扫描控制（6个数码管）

#### 动态扫描
- **扫描频率**：10KHz
- **扫描周期**：6个时钟周期（约600us）
- **每个数码管显示时间**：约100us
- **刷新频率**：约1.67KHz（人眼无法察觉闪烁）
- **扫描顺序**：分高位、分低位、秒高位、秒低位、毫秒高位、毫秒低位

#### BCD转换
- **bin_to_bcd**：二进制转BCD码，使用组合逻辑实现
- **bcd_to_seg7**：BCD码转7段显示码，使用查找表（case语句）

#### 7段译码
- **数码管类型**：共阳极
- **段码定义**：0表示点亮，1表示熄灭
- **段码顺序**：seg7[6:0] = {g, f, e, d, c, b, a}

### 3.5 按键处理模块

#### 边沿检测
- **实现位置**：顶层模块内
- **检测方式**：使用寄存器延迟，检测下降沿（按键按下）
- **输出**：单时钟周期脉冲信号

#### 按键功能映射
- **BTNC (CLR)**：复位，低电平有效
- **BTNL (PAUSE)**：暂停，低电平有效
- **BUTR (record_btn_raw)**：
  - 实时模式：记录时间
  - 翻阅模式：翻阅下一个存储时间
- **BUTU (browse_btn_raw)**：
  - 实时模式：进入翻阅模式
  - 翻阅模式：退出翻阅模式

## 四、实现细节

### 4.1 时钟域设计

**主时钟域（50MHz）**：
- 按键边沿检测
- 时间存储控制
- 顶层模块控制逻辑

**100Hz时钟域**：
- 百分秒计数
- 秒计数
- 分计数

**10KHz时钟域**：
- 数码管动态扫描

### 4.2 跨时钟域处理

**按键信号**：
- 在主时钟域进行边沿检测
- 输出单脉冲信号，传递给存储模块

**时间数据**：
- 从100Hz时钟域传递到主时钟域（存储）
- 从主时钟域传递到10KHz时钟域（显示）
- 由于数据变化缓慢，可以直接传递（不需要同步器）

### 4.3 复位策略

**复位信号**：
- CLR按键低电平有效（按下时为0）
- 内部转换为rst_n（低电平有效）
- 所有模块使用异步复位（negedge rst_n）

**复位行为**：
- 所有计数器清零
- 存储单元清零
- 显示索引复位为0
- 模式复位为实时模式

### 4.4 暂停功能

**暂停条件**：
- PAUSE按键按下（低电平）
- 处于翻阅模式（browse_mode=1）

**暂停行为**：
- 所有计数器保持当前值
- 不影响存储和翻阅功能
- 退出暂停后继续计数

### 4.5 LED指示功能

**按键指示LED**（按下时亮）：
- LED15：BTNC（CLR）按键状态
- LED14：BTNL（PAUSE）按键状态
- LED13：BTNR（record_btn_raw）按键状态
- LED12：BTNU（browse_btn_raw）按键状态

**测试LED**（显示边沿脉冲）：
- LED2：record_btn脉冲（边沿检测后）
- LED3：browse_btn脉冲（边沿检测后）

## 五、资源估算

### 5.1 逻辑资源

**LUT使用**：
- 时钟分频：约200个LUT
- 计数器：约150个LUT
- 时间存储：约200个LUT
- BCD转换：约100个LUT
- 7段译码：约50个LUT
- 数码管驱动：约100个LUT
- 按键处理：约50个LUT
- **总计**：约850个LUT

**FF使用**：
- 时钟分频：约40个FF
- 计数器：约30个FF
- 时间存储：约150个FF（6组×19位 + 控制逻辑）
- 数码管驱动：约10个FF
- 按键处理：约10个FF
- **总计**：约240个FF

### 5.2 资源利用率（xc7a35t）

- **LUT**: 约850 / 20800 = 4.1%
- **FF**: 约240 / 41600 = 0.6%
- **资源充足**，有足够余量

## 六、测试方案

### 6.1 功能测试

1. **复位测试**：
   - 按下BTNC按键，观察所有计数器和存储是否清零
   - 观察LED15是否亮起

2. **计数测试**：
   - 释放BTNC，观察数码管是否正常计数
   - 验证百分秒、秒、分的计数是否正确

3. **暂停测试**：
   - 按下BTNL按键，观察计数是否暂停
   - 观察LED14是否亮起
   - 释放BTNL，观察计数是否继续

4. **存储测试**：
   - 在实时模式下，按下BUTR按键记录时间
   - 观察LED13是否闪烁
   - 继续计数，再次按下BUTR
   - 验证是否存储了多组时间

5. **翻阅测试**：
   - 在实时模式下，按下BUTU按键进入翻阅模式
   - 观察LED12是否闪烁，计时器是否暂停
   - 按下BUTR按键，观察是否切换到下一个存储时间
   - 按下BUTU按键，观察是否退出翻阅模式

### 6.2 边界测试

1. **计数溢出测试**：
   - 验证99->0, 59->0的转换是否正确

2. **存储满测试**：
   - 记录7次，验证循环覆盖功能

3. **快速按键测试**：
   - 快速连续按键，验证边沿检测功能

## 七、引脚分配

### 7.1 时钟和按键

| 信号名 | 引脚 | 说明 |
|--------|------|------|
| clk | Y19 | 50MHz系统时钟 |
| CLR | Y18 | BTNC复位按键（低电平有效） |
| PAUSE | W22 | BTNL暂停按键（低电平有效） |
| record_btn_raw | Y22 | BUTR记录按键（低电平有效） |
| browse_btn_raw | V22 | BUTU翻阅按键（低电平有效） |

### 7.2 数码管输出

| 信号名 | 引脚 | 说明 |
|--------|------|------|
| DATA[0-7] | K21, H20, J22, K22, K19, J20, H19, J21 | 7段显示数据（a-g, dp） |
| DATA[8-15] | L21, L20, M22, M21, T1, U1, G20, H22 | 数码管位选（LED_S0-S7） |

### 7.3 LED输出

| 信号名 | 引脚 | 说明 |
|--------|------|------|
| LED_TEST[0] | AA20 | LED2，record_btn脉冲 |
| LED_TEST[1] | AB18 | LED3，browse_btn脉冲 |
| LED15 | AA1 | BTNC按键指示 |
| LED14 | AA3 | BTNL按键指示 |
| LED13 | AA4 | BTNR按键指示 |
| LED12 | AA5 | BTNU按键指示 |

## 八、使用说明

### 8.1 基本操作

1. **复位**：按下BTNC按键，所有计数器和存储清零
2. **开始计时**：释放BTNC，系统开始计时
3. **暂停**：按下BTNL按键，计时暂停；释放后继续
4. **记录时间**：在实时模式下，按下BUTR按键，当前时间存储到存储单元
5. **进入翻阅模式**：在实时模式下，按下BUTU按键，进入翻阅模式
6. **翻阅时间**：在翻阅模式下，按下BUTR按键，循环显示存储的6组时间
7. **退出翻阅模式**：在翻阅模式下，按下BUTU按键，退出翻阅模式，返回实时模式

### 8.2 LED指示说明

- **LED15-12**：按键按下时亮起，指示按键状态
- **LED2-3**：按键按下时闪烁，指示边沿检测脉冲

## 九、常见问题

### Q1: 数码管显示不正确

**A**: 检查以下几点：
- 7段译码表是否正确（共阳极/共阴极）
- 引脚分配是否正确
- 扫描频率是否合适

### Q2: 按键无响应

**A**: 检查以下几点：
- 按键引脚分配
- 按键极性（低电平有效）
- 边沿检测逻辑

### Q3: 计数不准确

**A**: 检查以下几点：
- 时钟分频比是否正确
- 进位逻辑是否正确
- 时钟约束是否正确

### Q4: 存储数据丢失

**A**: 检查以下几点：
- 存储逻辑和时序
- 复位信号干扰

### Q5: 翻阅模式无法退出

**A**: 检查以下几点：
- BUTU按键是否正常工作
- browse_mode信号是否正确

## 十、扩展功能（可选）

### 10.1 VGA显示模块

可以添加VGA显示模块，实现：
- 当前计时值大字体显示
- 已存储时间列表显示
- 当前翻阅组高亮显示

### 10.2 更多存储组

可以扩展存储容量，支持更多组时间存储。

### 10.3 时间比较功能

可以添加时间比较功能，显示最快/最慢时间。
